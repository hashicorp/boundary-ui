{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
}}
{{page-title (t 'resources.app-token.tabs.permissions')}}
<Breadcrumbs::Item
  @text={{t 'resources.app-token.tabs.permissions'}}
  @route='scopes.scope.app-tokens.app-token.permissions'
/>

<Rose::Layout::Page as |page|>
  <page.header>
    <Hds::PageHeader as |PH|>
      <PH.Breadcrumb>
        <Breadcrumbs::Container />
      </PH.Breadcrumb>
      <PH.Title>
        {{t 'resources.app-token.title_plural'}}
        <DocLink @doc='app-tokens' />
      </PH.Title>
      <PH.Description>
        {{t 'resources.app-token.description'}}
      </PH.Description>
      <PH.Actions>
        <AppTokens::AppToken::Actions
          @model={{@model}}
          @revoke={{fn this.appTokens.revoke @model}}
        />
      </PH.Actions>
      <PH.Generic>
        <Hds::Copy::Snippet @textToCopy={{@model.id}} @color='secondary' />
      </PH.Generic>
    </Hds::PageHeader>
  </page.header>

  <page.navigation>
    <AppTokens::AppToken::Nav />
  </page.navigation>

  <page.body>
    {{#if @model.hasPermissionWithEmptyActiveScopes}}
      <Hds::Alert
        class='margin-bottom-m'
        @type='inline'
        @color='warning'
        data-test-permissions-alert
        as |A|
      >
        <A.Title>{{t 'resources.app-token.messages.no-active-scopes.title'}}
        </A.Title>
        <A.Description>
          {{t
            'resources.app-token.messages.no-active-scopes.description'
            htmlSafe=true
          }}
        </A.Description>
        {{#if (can 'clone app-token' @model)}}
          <A.Button
            @color='secondary'
            @text={{t 'resources.app-token.actions.clone'}}
            @route='scopes.scope.app-tokens.new'
            @query={{hash cloneAppToken=@model.id}}
            data-test-inline-clone-btn
          />
        {{/if}}
        {{#if (can 'delete app-token' @model)}}
          <A.Button
            @color='tertiary'
            @text={{t 'resources.app-token.actions.delete'}}
            @icon='trash'
            data-test-inline-delete-btn
            {{on 'click' this.toggleDeleteModal}}
          />
        {{/if}}
      </Hds::Alert>
    {{/if}}

    <Hds::Table
      @model={{@model.permissions}}
      @columns={{array
        (hash label=(t 'resources.app-token.titles.labels'))
        (hash label=(t 'resources.app-token.titles.grants'))
        (hash
          label=(t 'resources.app-token.titles.active-scopes')
          tooltip=(t 'resources.app-token.messages.tooltips.active-scopes')
        )
        (hash label=(t 'resources.app-token.titles.deleted-scopes'))
      }}
      @valign='middle'
    >
      <:body as |B|>
        <B.Tr>
          <B.Td>
            {{#if B.data.label}}
              {{B.data.label}}
            {{else}}
              —
            {{/if}}
          </B.Td>
          <B.Td>
            {{#if B.data.grant.length}}
              <Hds::Button
                @text={{B.data.grant.length}}
                @color='tertiary'
                @icon='code'
                @size='small'
                {{on 'click' (fn this.openGrantsFlyout B.data)}}
              />
            {{else}}
              —
            {{/if}}
          </B.Td>
          <B.Td>
            {{#if B.data.grant_scopes}}
              <Hds::Button
                @text={{B.data.grant_scopes.length}}
                @color='tertiary'
                @icon='list'
                @size='small'
                {{on 'click' (fn this.openActiveScopesFlyout B.data)}}
              />
            {{else}}
              —
            {{/if}}
          </B.Td>
          <B.Td>
            {{#if B.data.deleted_scopes.length}}
              <Hds::Button
                @text={{B.data.deleted_scopes.length}}
                @color='tertiary'
                @icon='list'
                @size='small'
                {{on 'click' (fn this.openDeletedScopesFlyout B.data)}}
              />
            {{else}}
              —
            {{/if}}
          </B.Td>
        </B.Tr>
      </:body>
    </Hds::Table>

    {{#if this.showGrantsFlyout}}
      <Hds::Flyout
        data-test-grants-flyout
        @size='medium'
        @onClose={{this.closeGrantsFlyout}}
        as |F|
      >
        <F.Header>{{t 'resources.app-token.titles.grants'}}</F.Header>
        <F.Body>
          <Hds::Table
            @model={{this.selectedPermission.grant}}
            @columns={{array
              (hash label=(t 'resources.app-token.titles.grant'))
            }}
            @valign='middle'
          >
            <:body as |B|>
              <B.Tr>
                <B.Td>
                  <Hds::Text::Code @tag='span'>{{B.data}}</Hds::Text::Code>
                </B.Td>
              </B.Tr>
            </:body>
          </Hds::Table>
        </F.Body>
        <F.Footer>
          <Hds::Button
            @text={{t 'actions.close'}}
            @color='secondary'
            {{on 'click' this.closeGrantsFlyout}}
          />
        </F.Footer>
      </Hds::Flyout>
    {{/if}}

    {{#if this.showActiveScopesFlyout}}
      <Hds::Flyout
        data-test-active-scopes-flyout
        @size='medium'
        @onClose={{this.closeActiveScopesFlyout}}
        as |F|
      >
        <F.Header>{{t 'resources.app-token.titles.active-scopes'}}</F.Header>
        <F.Body>
          <Hds::Table
            @model={{this.activeScopesList}}
            @columns={{array
              (hash label=(t 'resources.scope.title'))
              (hash label=(t 'form.id.label'))
            }}
            @valign='middle'
          >
            <:body as |B|>
              <B.Tr>
                <B.Td>
                  {{#if (eq B.data.id 'this')}}
                    <LinkTo @route='scopes.scope' @model={{B.data.scopeId}}>
                      {{B.data.displayName}}
                    </LinkTo>
                  {{else if (can 'read model' B.data)}}
                    <LinkTo @route='scopes.scope' @model={{B.data.id}}>
                      {{B.data.displayName}}
                    </LinkTo>
                  {{else if B.data.isKeyword}}
                    {{B.data.displayName}}
                  {{else}}
                    {{B.data.displayName}}
                  {{/if}}
                </B.Td>
                <B.Td>
                  <Hds::Copy::Snippet
                    @textToCopy={{B.data.id}}
                    @color='secondary'
                  />
                </B.Td>
              </B.Tr>
            </:body>
          </Hds::Table>
        </F.Body>
        <F.Footer>
          <Hds::Button
            @text={{t 'actions.close'}}
            @color='secondary'
            {{on 'click' this.closeActiveScopesFlyout}}
          />
        </F.Footer>
      </Hds::Flyout>
    {{/if}}

    {{#if this.showDeletedScopesFlyout}}
      <Hds::Flyout
        data-test-deleted-scopes-flyout
        @size='medium'
        @onClose={{this.closeDeletedScopesFlyout}}
        as |F|
      >
        <F.Header>{{t 'resources.app-token.titles.deleted-scopes'}}</F.Header>
        <F.Body>
          <Hds::Text::Body @tag='p'>
            {{#if this.selectedPermission.label}}
              {{t
                'resources.app-token.messages.deleted-scopes.description-with-label'
                label=this.selectedPermission.label
              }}
            {{else}}
              {{t
                'resources.app-token.messages.deleted-scopes.description-no-label'
              }}
            {{/if}}
          </Hds::Text::Body>
          <Hds::Table
            class='margin-top-m'
            @model={{this.deletedScopesList}}
            @columns={{array
              (hash label=(t 'form.id.label'))
              (hash label=(t 'resources.app-token.titles.deleted-at'))
            }}
            @valign='middle'
          >
            <:body as |B|>
              <B.Tr>
                <B.Td>
                  <Hds::Copy::Snippet
                    @textToCopy={{B.data.scope_id}}
                    @color='secondary'
                  />
                </B.Td>
                <B.Td>
                  <Hds::Time @date={{B.data.deleted_at}} @display='relative' />
                </B.Td>
              </B.Tr>
            </:body>
          </Hds::Table>
        </F.Body>
        <F.Footer>
          <Hds::Button
            @text={{t 'actions.close'}}
            @color='secondary'
            {{on 'click' this.closeDeletedScopesFlyout}}
          />
        </F.Footer>
      </Hds::Flyout>
    {{/if}}
  </page.body>
</Rose::Layout::Page>

{{! Delete Modal - triggered from no active scopes alert }}
{{#if this.showDeleteModal}}
  <Hds::Modal @color='critical' @onClose={{this.toggleDeleteModal}} as |M|>
    <M.Header @icon='alert-diamond'>{{t
        'resources.app-token.form.delete.title'
      }}</M.Header>
    <M.Body class='app-token-modal-body'>
      <Hds::Text::Body @tag='p'>
        {{t
          'resources.app-token.form.delete.description.0'
          appToken=@model.displayName
          htmlSafe=true
        }}
      </Hds::Text::Body>
      <Hds::Text::Body @tag='p'>
        {{t 'resources.app-token.form.delete.description.1'}}
      </Hds::Text::Body>
      <Hds::Form::TextInput::Field
        name='confirm-delete'
        @value={{this.deleteConfirmation}}
        @isRequired={{true}}
        disabled={{@model.isSaving}}
        {{on 'input' (set-from-event this 'deleteConfirmation')}}
        as |F|
      >
        <F.Label>{{t
            'resources.app-token.form.delete.confirm-delete.label'
          }}</F.Label>
        <F.HelperText>{{t
            'resources.app-token.form.delete.confirm-delete.help'
          }}</F.HelperText>
      </Hds::Form::TextInput::Field>
    </M.Body>
    <M.Footer as |F|>
      <Hds::ButtonSet>
        <Hds::Button
          @text={{t 'actions.confirm'}}
          @color='critical'
          disabled={{not this.isDeleteConfirmed}}
          {{on 'click' this.handleDelete}}
        />
        <Hds::Button
          @text={{t 'actions.cancel'}}
          @color='secondary'
          {{on 'click' F.close}}
        />
      </Hds::ButtonSet>
    </M.Footer>
  </Hds::Modal>
{{/if}}