{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: MPL-2.0
}}

<Rose::Layout::Page as |page|>

  <page.header>
    <h2>
      {{t 'resources.target.title_plural'}}
      <DocLink @doc='targets' @iconSize='large' />
    </h2>
    <p>{{t 'resources.target.description'}}</p>
  </page.header>

  <page.body class='search-filtering'>
    {{#if (or @model.targets this.search)}}
      <Hds::SegmentedGroup as |sg|>
        <sg.TextInput
          @type='search'
          placeholder={{t 'actions.search'}}
          aria-label={{t 'actions.search'}}
          {{on 'input' this.handleSearchInput}}
        />
        <sg.Generic>
          <Rose::FilterableDropdown
            @name={{t 'resources.scope.title'}}
            @itemOptions={{this.availableScopes}}
            @checkedItems={{this.scopes}}
            @applyFilter={{this.applyFilter}}
            @isSearchable={{true}}
            as |fd selectItem itemOptions|
          >
            {{#let (group-by itemOptions 'scopeModel') as |orgs|}}
              {{#each orgs as |org|}}
                <fd.Generic>
                  <FlightIcon @name='org' />
                  {{org.key.displayName}}
                </fd.Generic>
                {{#each org.items as |project|}}
                  <fd.Checkbox
                    @value={{project.id}}
                    data-test-checkbox={{project.name}}
                    checked={{includes project.id this.scopes}}
                    {{on 'change' selectItem}}
                  >
                    {{project.displayName}}
                  </fd.Checkbox>
                {{/each}}
              {{/each}}
            {{/let}}
          </Rose::FilterableDropdown>
        </sg.Generic>
        <sg.Dropdown as |dd|>
          <dd.ToggleButton @color='secondary' @text='Active session' />
          <dd.Checkbox>{{t 'actions.yes'}}</dd.Checkbox>
          <dd.Checkbox>{{t 'actions.no'}}</dd.Checkbox>
        </sg.Dropdown>
        <sg.Dropdown as |dd|>
          <dd.ToggleButton @color='secondary' @text='Type' @count='2' />
          <dd.Checkbox>{{t 'resources.target.types.tcp'}}</dd.Checkbox>
          <dd.Checkbox>{{t 'resources.target.types.ssh'}}</dd.Checkbox>
        </sg.Dropdown>
      </Hds::SegmentedGroup>
      {{#if @model.targets}}
        <Hds::Table
          @model={{@model.targets}}
          @columns={{array
            (hash label=(t 'form.name.label'))
            (hash label=(t 'form.id.label'))
            (hash label=(t 'form.type.label'))
            (hash label=(t 'resources.project.title'))
            (hash label='')
          }}
          @valign='middle'
        >
          <:body as |b|>
            <b.Tr>
              <b.Td>
                <span class='hds-font-weight-semibold'>
                  {{#if (can 'read model' b.data)}}
                    <LinkTo
                      data-test-visit-target={{b.data.id}}
                      @route='scopes.scope.projects.targets.target'
                      @model={{b.data.id}}
                      @query={{hash isConnecting=false}}
                    >
                      {{b.data.displayName}}
                    </LinkTo>
                  {{else}}
                    {{b.data.displayName}}
                  {{/if}}
                  {{#if b.data.description}}
                    <p>{{b.data.description}}</p>
                  {{/if}}
                </span>
              </b.Td>
              <b.Td>
                <Copyable
                  @text={{b.data.id}}
                  @buttonText={{t 'actions.copy-to-clipboard'}}
                  @acknowledgeText={{t 'states.copied'}}
                >
                  <code>{{b.data.id}}</code>
                </Copyable>
              </b.Td>
              <b.Td>
                {{#if b.data.type}}
                  <Hds::Badge
                    @text={{t (concat 'resources.target.types.' b.data.type)}}
                  />
                {{/if}}
              </b.Td>
              <b.Td>
                <div>
                  <Copyable
                    @text={{b.data.project.id}}
                    @buttonText={{t 'actions.copy-to-clipboard'}}
                    @acknowledgeText={{t 'states.copied'}}
                  >
                    <code>{{b.data.project.id}}</code>
                  </Copyable>
                </div>
                {{#if b.data.project.name}}
                  <Hds::Badge @color='neutral' @text={{b.data.project.name}} />
                {{/if}}
              </b.Td>
              <b.Td>
                {{#if (can 'connect target' b.data)}}
                  {{#if (can 'read target' b.data)}}
                    <Hds::Button
                      data-test-targets-connect-button={{b.data.id}}
                      @text={{t 'resources.session.actions.connect'}}
                      @color='secondary'
                      @route='scopes.scope.projects.targets.target'
                      @model={{b.data.id}}
                      @query={{hash isConnecting=true}}
                    />
                  {{else}}
                    <Hds::Button
                      data-test-targets-connect-button={{b.data.id}}
                      @text={{t 'resources.session.actions.connect'}}
                      @color='secondary'
                      {{on 'click' (fn this.quickConnect b.data)}}
                    />
                  {{/if}}
                {{/if}}
              </b.Td>
            </b.Tr>
          </:body>
        </Hds::Table>
        <Rose::Pagination
          @totalItems={{@model.totalItems}}
          @currentPage={{this.page}}
          @currentPageSize={{this.pageSize}}
        />

      {{/if}}
      {{#if this.noResults}}
        <Hds::ApplicationState data-test-no-target-results as |a|>
          <a.Header
            @title={{t 'resources.target.messages.no-search-results.title'}}
          />
          <a.Body
            @text={{t
              'resources.target.messages.no-search-results.description'
              query=this.search
            }}
          />
        </Hds::ApplicationState>
      {{/if}}
    {{/if}}
    {{#if this.noTargets}}
      <Hds::ApplicationState data-test-no-targets as |a|>
        <a.Header @title={{t 'resources.target.messages.none.title'}} />
        <a.Body @text={{t 'resources.target.messages.none.description'}} />
      </Hds::ApplicationState>
    {{/if}}
  </page.body>

</Rose::Layout::Page>